{
    # GLOBAL OPTIONS
    servers {
        protocols h1 h2 h3
        max_header_size 32KB
        timeouts {
            read_header 20s
            read_body 30s
            write 30s
            idle 180s
        }
    }
}

processsutra.com, www.processsutra.com {
    encode zstd gzip

    reverse_proxy 127.0.0.1:5000 {
        # Transport tuning
        transport http {
            keepalive 120s
            keepalive_idle_conns 200
            max_conns_per_host 0
            read_buffer 64KB
            write_buffer 64KB

            dial_timeout 10s
            tls_timeout 10s
            response_header_timeout 30s
        }

        # Correct upstream headers (VERY IMPORTANT)
        header_up Host {host}
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Port {server_port}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Real-IP {http.request.remote}
        header_up X-Forwarded-For {http.request.remote}
    }

    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        -Server

        Content-Security-Policy "
            default-src 'self';
            script-src 'self' 'unsafe-inline' https://accounts.google.com https://apis.google.com;
            style-src 'self' 'unsafe-inline' https://accounts.google.com;
            img-src 'self' data: https://accounts.google.com;
            frame-src https://accounts.google.com;
            connect-src 'self' https://accounts.google.com https://oauth2.googleapis.com;
        "
    }

    # Static asset caching
    @static {
        path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100MB
            roll_keep 5
            roll_keep_for 30d
        }
    }
}

# Redirect IP to domain
http://194.238.16.140 {
    redir https://processsutra.com{uri} permanent
}
